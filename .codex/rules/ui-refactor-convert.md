---
alwaysApply: false
---
# UI Refactor Rule for Convert Output (JSX/Figma -> Dart)

## 1. Goal
Turn generated UI code into production-ready Flutter code that fully complies with `ui.md`.

This rule applies after running convert scripts (for example files like `home_demo_figma_page.dart` and generated component trees), especially when convert output creates non-standard asset names/folders.

## 1.1 Required References
Always apply together with:
- [ui.md](./ui.md)
- [flutter-ui-widgets](../skills/flutter-ui-widgets/SKILL.md)
- [flutter-assets-management](../skills/flutter-assets-management/SKILL.md)
- [getx-localization-standard](../skills/getx-localization-standard/SKILL.md)
- [dart-best-practices](../skills/dart-best-practices/SKILL.md)
- [ci-cd-pr.md](./ci-cd-pr.md)

If API data is involved, also apply:
- [integration-api.md](./integration-api.md)
- [dart-model-reuse](../skills/dart-model-reuse/SKILL.md)

## 2. Trigger Conditions
Use this rule when at least one condition is true:
- Source file is generated by convert pipeline.
- Class/file names are non-semantic (for example: `UhomeUdemoFigma`, `Frame123`).
- Generated UI has hardcoded strings/colors/styles or deep nested widget trees.
- Converted UI works visually but fails architecture/readability/maintainability standards.

## 3. Refactor Workflow

### Step 1: Normalize Structure and Naming
- Keep page architecture:
  - `lib/src/ui/<feature>/{binding,interactor,components}`
- Rename generated class/file names to semantic names.
- Keep page entry simple (`<feature>_page.dart` should not contain huge raw trees).
- Enforce decomposition contract:
  - `<feature>_page.dart` is composition-only.
  - Major sections go to `components/*.dart` (header/form/list/footer/dialog section...).
  - Do not keep convert output as a single giant widget tree in one file.

### Step 2: Apply Design Tokens and Shared Widgets
- Replace raw style values with:
  - `AppColors`
  - `AppStyles`
  - `AppDimensions` and extensions (`n.width`, `n.height`)
- Replace raw controls with existing `App*` widgets where applicable.
- Keep exact Figma values when overriding tokens (radius/spacing/typography).

### Step 3: Remove Convert Artifacts
- Remove redundant wrappers (`ClipRRect + Container` duplicates, empty containers, unnecessary stacks).
- Reduce deeply nested UI into clear sub-components under `components/`.
- If `build()` is large or screen has multiple sections/states, split immediately; do not wait for reuse.
- Add `const` where possible.
- Avoid `Get.width` direct usage when local layout constraints are more correct (`LayoutBuilder`, `MediaQuery` scoped use).

### Step 4: Localization and Content Cleanup
- Move all user-facing text to `LocaleKey` + `.tr`.
- Create/Update feature key module:
  - `lib/src/locale/keys/<feature>_locale_key.dart`
- Create/Update language modules:
  - `lib/src/locale/en/<feature>_en.dart`
  - `lib/src/locale/ja/<feature>_ja.dart`
  - `lib/src/locale/vi/<feature>_vi.dart` (when `vi_VN` is supported)
- Ensure `lang_*.dart` only aggregate feature maps (do not inject random inline feature strings).
- Ensure key parity across all active locale modules for the refactored feature.
- If the target project uses JSON locale source files, update those files first, then regenerate/update Dart locale modules.
- Refactor is incomplete if any localization module file above is missing.
- Do not keep demo/static strings inside production widget tree.
- If temporary mock is needed, source it from `app_demo_data.dart`.

### Step 5: State and Behavior Correctness
- Ensure required states render correctly:
  - `loading`, `success`, `empty`, `error` (plus `unauthorized` if relevant).
- Ensure UI behavior is not only visual:
  - tap handlers wired,
  - enabled/disabled state clear,
  - no broken interaction overlays.

### Step 6: Asset and Icon Hygiene
- Use `AppAssets` only (no raw asset path in widget code).
- Keep icon/image naming consistent and avoid duplicates.
- Verify SVG rendering without unexpected tint/color shift and without mobile parser errors.
- If source is Figma MCP output, save MCP asset URL mapping to:
  - `spec/figma-assets/<feature>-mcp-assets.json`
  - then run:
    - `node tool/download_figma_mcp_assets.mjs --assets spec/figma-assets/<feature>-mcp-assets.json --feature <feature>`
    - script auto-normalizes SVG for Flutter/mobile compatibility by default.
    - use `--no-normalize-svg` only for debugging raw source.
  - If SVG still fails on mobile, re-run normalize flow and verify there are no web-only tags (`foreignObject`, `script`) in output.
- Normalize convert-generated asset folders and names:
  - Detect non-standard convert folders (for example: `assets/figma/**`).
  - Move/rename assets to feature-scoped locations:
    - `assets/images/<feature>/**`
    - `assets/images/icons/<feature>/**`
  - Rename files to meaningful `snake_case` names based on feature and purpose.
  - Replace convert-style asset constants in `lib/src/utils/app_assets.dart` with feature-scoped naming.
  - Update all usages in Dart code to new `AppAssets` constants.
  - Prevent cross-feature collisions (same filename/constant for different meanings).
  - Keep shared assets explicitly under shared scope only when truly reused.
  - Remove orphan/unused old asset files and constants.
  - Review report output in `spec/figma-assets/<feature>-asset-map.json` before final replace.

### Step 7: Verify and Prepare for PR
- Run at minimum:
  - `fvm flutter analyze`
- Validate UI correctness gates from `ui.md`:
  - responsive widths `320/390/430`
  - text scale `1.0/1.3`
  - no overflow warnings in debug logs

### Step 8: Commit/Push/PR Confirmation (Mandatory)
- After refactor verification, ask user in strict order:
  1. `Do you want me to commit now? (yes/no)`
  2. `Do you want me to push now? (yes/no)`
  3. `Do you want me to create PR now? (yes/no)`
- Execute only steps explicitly confirmed with `yes`.
- If user answers `no` at any step, stop there and return current status.

## 4. Mandatory Output of Refactor Task
After refactor, output must include:
- List of renamed files/classes.
- List of extracted components.
- Proof that page is not monolithic:
  - `<feature>_page.dart` responsibility summary.
  - section-to-component mapping (`section -> file`).
- List of localized keys added/updated.
- Localization module files created/updated per feature (`en/<feature>_en.dart`, `ja/<feature>_ja.dart`, `vi/<feature>_vi.dart` when enabled) and non-empty check.
- Locale key parity status for all active locales.
- If JSON locale sources exist in project: JSON files created/updated and sync status to Dart modules.
- List of token replacements (`raw -> AppColors/AppStyles/AppDimensions`).
- Asset rename mapping (`old path/name -> new path/name`) and updated feature-scoped `AppAssets` constants.
- Feature asset placement report (`feature -> directories/constants`) to prove no cross-feature mixing.
- MCP asset download report path and summary (if MCP flow was used).
- Commit/push/PR confirmation answers and execution results.
- Remaining known gaps (if any) with exact file paths.

## 5. Anti-Patterns (Do Not)
- Do not keep generated class names in final code.
- Do not keep all converted UI in one page file for multi-section screens.
- Do not leave hardcoded colors/text if a project token/key exists.
- Do not keep feature localization inline in `lang_*.dart` aggregators.
- Do not leave locale folders without actual feature files/content.
- Do not keep unmatched keys between active locale modules for the same feature.
- Do not keep convert-only asset naming/folders in final code if they violate project standard.
- Do not place feature-specific assets in generic folders without feature namespace.
- Do not reuse ambiguous asset constants across different features.
- Do not parse API JSON directly in UI widgets.
- Do not submit refactor that only changes formatting but leaves architectural violations.

## 6. Prompt Template
Use this prompt to trigger this rule:

> Refactor converted UI using `ui-refactor-convert.md` + `ui.md`.
> Source: `<path-to-generated-page-or-component>`.
> Keep visual fidelity, but enforce architecture/tokens/localization/state correctness.
> Extract reusable components and remove convert artifacts.
> Normalize asset folder/naming by feature and update `AppAssets` with feature-scoped constants.
> Split localization by feature module maps (`en/ja/vi` when enabled) and update LocaleKey feature module.
> Then ask: commit now? push now? create PR now?
> Return changed files and verification checklist results.
